name: CI/CD Pipeline - Build and Deploy

on:
    push:
        branches:
            - main
            - master
            - develop
            - "feature/**"
    pull_request:
        branches:
            - main
            - master
            - develop

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}
    APP_PORT: "8080"
    STAGING_PORT: "8081"

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        outputs:
            build-version: ${{ steps.version.outputs.version }}

        steps:
            - name: Descargar código
              uses: actions/checkout@v4

            - name: Configurar JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: maven

            - name: Instalar dependencia local Zebra SDK
              run: mvn install:install-file -Dfile=Link-OS_SDK/PC/v2.15.5553/lib/ZSDK_API.jar -DgroupId=com.zebra.sdk -DartifactId=zsdk_api -Dversion=2.15.5553 -Dpackaging=jar

            - name: Compilar con Maven
              run: mvn clean package -DskipTests

            - name: Obtener versión
              id: version
              run: echo "version=$(date +%s)" >> $GITHUB_OUTPUT

            - name: Subir JAR como artefacto
              uses: actions/upload-artifact@v4
              with:
                  name: app-jar
                  path: target/*.jar
                  retention-days: 1

            - name: Mostrar ruta del JAR
              run: ls -la target/

    deploy-production:
        needs: build
        runs-on: [self-hosted, Windows]
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        environment: production
        timeout-minutes: 15

        steps:
            - name: Descargar artefacto JAR
              uses: actions/download-artifact@v4
              with:
                  name: app-jar
                  path: ./app

            - name: Detener aplicación anterior
              shell: powershell
              run: |
                  $processName = "java"
                  $proc = Get-Process $processName -ErrorAction SilentlyContinue
                  if ($proc) {
                    Write-Host "Deteniendo proceso Java..."
                    Stop-Process -Name $processName -Force -ErrorAction SilentlyContinue
                    Start-Sleep -Seconds 3
                  } else {
                    Write-Host "No hay proceso Java ejecutándose"
                  }

            - name: Ejecutar aplicación
              shell: powershell
              run: |
                  $jarFile = Get-ChildItem -Path ./app -Filter *.jar | Select-Object -First 1
                  if (-not $jarFile) {
                    Write-Host "No JAR file found"
                    exit 1
                  }
                  
                  $jarPath = $jarFile.FullName
                  Write-Host "Ejecutando: $jarPath"
                  
                  # Ejecutar en segundo plano
                  Start-Process -FilePath "java" `
                               -ArgumentList "-jar", "`"$jarPath`"" `
                               -WorkingDirectory "./app" `
                               -NoNewWindow `
                               -PassThru
                  
                  Write-Host "Aplicación iniciada exitosamente"
                  Start-Sleep -Seconds 5
                  
                  # Verificar que se ejecutó
                  $running = Get-Process java -ErrorAction SilentlyContinue
                  if ($running) {
                    Write-Host "✓ Aplicación ejecutándose en puerto ${{ env.APP_PORT }}"
                  } else {
                    Write-Host "Error: No se pudo iniciar la aplicación"
                    exit 1
                  }

            - name: Detener y eliminar contenedor existente
              shell: powershell
              run: |
                  $container = docker ps -a -q -f "name=backend-app"
                  if ($container) {
                    Write-Host "Deteniendo contenedor existente..."
                    docker stop $container -t 30
                    docker rm $container
                  }

            - name: Ejecutar contenedor Docker (Producción)
              shell: powershell
              run: |
                  docker run -d `
                    --name backend-app `
                    -p ${{ env.APP_PORT }}:8080 `
                    --restart unless-stopped `
                    --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" `
                    --health-interval=10s `
                    --health-timeout=5s `
                    --health-retries=3 `
                    ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            - name: Esperar a que el contenedor esté saludable
              shell: powershell
              run: |
                  $maxAttempts = 30
                  $attempt = 0
                  $healthy = $false

                  while ($attempt -lt $maxAttempts) {
                    $health = docker inspect --format='{{.State.Health.Status}}' backend-app 2>$null
                    if ($health -eq "healthy") {
                      Write-Host "El contenedor está saludable"
                      $healthy = $true
                      break
                    }
                    Start-Sleep -Seconds 1
                    $attempt++
                  }

                  if (-not $healthy) {
                    Write-Host "El contenedor no logró estar saludable"
                    docker logs backend-app
                    exit 1
                  }

            - name: Verificar despliegue de producción
              shell: powershell
              run: |
                  $running = docker ps -q -f "name=backend-app"
                  if ($running) {
                    Write-Host "Despliegue de producción exitoso"
                    Write-Host "ID del Contenedor: $running"
                    docker logs backend-app -n 20
                  } else {
                    Write-Host "El contenedor falló al iniciar en producción"
                    exit 1
                  }

    despliegue-staging:
        needs: build
        runs-on: [self-hosted, Windows]
        if: github.ref == 'refs/heads/develop'
        environment: staging
        timeout-minutes: 15
        permissions:
            contents: read
            packages: read

        steps:
            - name: Descargar código
              uses: actions/checkout@v4

            - name: Iniciar sesión en Registro de Contenedores
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Descargar imagen Docker (Desarrollo)
              shell: powershell
              run: |
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop
                  Write-Host "Imagen de staging descargada exitosamente"

            - name: Detener y eliminar contenedor de staging existente
              shell: powershell
              run: |
                  $container = docker ps -a -q -f "name=backend-app-staging"
                  if ($container) {
                    Write-Host "Deteniendo contenedor de staging existente..."
                    docker stop $container -t 30
                    docker rm $container
                  }

            - name: Ejecutar contenedor Docker (Staging)
              shell: powershell
              run: |
                  docker run -d `
                    --name backend-app-staging `
                    -p ${{ env.STAGING_PORT }}:8080 `
                    --restart unless-stopped `
                    --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" `
                    --health-interval=10s `
                    --health-timeout=5s `
                    --health-retries=3 `
                    ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop

            - name: Esperar a que el contenedor de staging esté saludable
              shell: powershell
              run: |
                  $maxAttempts = 30
                  $attempt = 0
                  $healthy = $false

                  while ($attempt -lt $maxAttempts) {
                    $health = docker inspect --format='{{.State.Health.Status}}' backend-app-staging 2>$null
                    if ($health -eq "healthy") {
                      Write-Host "El contenedor de staging está saludable"
                      $healthy = $true
                      break
                    }
                    Start-Sleep -Seconds 1
                    $attempt++
                  }

                  if (-not $healthy) {
                    Write-Host "El contenedor de staging no logró estar saludable"
                    docker logs backend-app-staging
                    exit 1
                  }

            - name: Verificar despliegue de staging
              shell: powershell
              run: |
                  $running = docker ps -q -f "name=backend-app-staging"
                  if ($running) {
                    Write-Host "Despliegue de staging exitoso"
                    Write-Host "ID del Contenedor: $running"
                    docker logs backend-app-staging -n 20
                  } else {
                    Write-Host "El contenedor de staging falló al iniciar"
                    exit 1
                  }
